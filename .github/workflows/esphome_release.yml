name: ESPHome Release

on:
  pull_request:
    types: [closed]
    branches: [main]
    paths:
      - esphome/**/*.yaml
  workflow_dispatch:
    inputs:
      tag:
        description: "Existing tag to release (e.g., esphome-1.2.3)"
        required: true
        type: string

jobs:
  build-firmware:
    name: Build Firmware
    runs-on: ubuntu-latest
    permissions:
      contents: write
    if: >
      github.event_name == 'workflow_dispatch' ||
      (
        github.event_name == 'pull_request' &&
        github.event.action == 'closed' &&
        github.event.pull_request.merged == true &&
        startsWith(github.event.pull_request.head.ref, 'esphome-')
      )
    outputs:
      project_version: ${{ steps.esphome-build.outputs.project-version }}
      project_name:    ${{ steps.esphome-build.outputs.name }}
      esphome_version: ${{ steps.esphome-build.outputs.version }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          ref: ${{ github.event_name == 'workflow_dispatch'
                  && format('refs/tags/{0}', inputs.tag)
                  || github.event.pull_request.merge_commit_sha }}

      - name: Build Firmware
        uses: esphome/build-action@v7
        id: esphome-build
        with:
          yaml-file: esphome/huenergydisplay.factory.yaml
          complete-manifest: true

      - name: Upload firmware artifacts
        uses: actions/upload-artifact@v4
        with:
          name: firmware-${{ steps.esphome-build.outputs.project-version }}
          path: |
            ${{ steps.esphome-build.outputs.name }}/${{ steps.esphome-build.outputs.name }}.factory.bin
            ${{ steps.esphome-build.outputs.name }}/${{ steps.esphome-build.outputs.name }}.ota.bin
            ${{ steps.esphome-build.outputs.name }}/manifest.json

  extract_release_notes:
    name: Extract release notes for release
    runs-on: ubuntu-latest
    needs: build-firmware
    outputs:
      notes: ${{ steps.extract_notes.outputs.notes }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
          ref: ${{ github.event_name == 'workflow_dispatch'
                  && format('refs/tags/{0}', inputs.tag)
                  || github.event.pull_request.merge_commit_sha }}
      - name: Extract changelog notes
        id: extract_notes
        env:
          VERSION: ${{ needs.build-firmware.outputs.project_version }}
          ESPHOME: ${{ needs.build-firmware.outputs.esphome_version }}
        shell: bash
        run: |
          set -euo pipefail

          CHANGELOG="esphome/CHANGELOG.md"

          NOTES="$(tr -d '\r' < "$CHANGELOG" | awk -v ver="$VERSION" '
            BEGIN { found=0 }
            /^## \[/ {
              if (found) exit 0
              if ($0 ~ "^## \\[" ver "\\]") { found=1; print; next }
              next
            }
            found { print }
          ')"

          if [[ -z "$NOTES" ]]; then
            echo "âŒ Version '$VERSION' not found in $CHANGELOG" >&2
            exit 1
          fi

          {
            echo "notes<<EOF_NOTES"
            printf "%s\n" "$NOTES"
            echo
            echo
            echo "Built by esphome $ESPHOME"
            echo "EOF_NOTES"
          } >> "$GITHUB_OUTPUT"

  create_release:
    name: Create GitHub Release
    needs: [build-firmware,extract_release_notes]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Download firmware artifacts
        uses: actions/download-artifact@v4
        with:
          name: firmware-${{ needs.build-firmware.outputs.project_version }}
          path: ./release-assets

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          tag_name: esphome-${{ needs.build-firmware.outputs.project_version }}
          name: esphome-${{ needs.build-firmware.outputs.project_version }}
          body: ${{ needs.extract_release_notes.outputs.notes }}
          files: |
            release-assets/${{ needs.build-firmware.outputs.project_name }}.factory.bin
            release-assets/${{ needs.build-firmware.outputs.project_name }}.ota.bin
            release-assets/manifest.json
